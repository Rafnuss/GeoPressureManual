# Create

In this guide, we explore how to generate a GeoLocator Data Package from a GeoPressureTemplate folder where you've already performed the analysis of the tracks following the [GeoPressureTemplate workflow](geopressuretemplate-workflow.html).

::: callout-important
To be able to follow this guide, you need to have a GeoPressureTemplate project containing:

- An up-to-date `DESCRIPTION` file, including `version`, `contributors`, `licences` as described in [the R packages book](https://r-pkgs.org/description.html). 
- One interim `.RData` file per tag, with all outputs you would like to publish, generated with the [Geopressuretemplate workflow](geopressuretemplate-workflow.html).
- The `tag.csv` and `observations.csv` files in the `data/` folder.
::: 

::: callout-info
If you've not yet performed the GeoPressureR analysis, it is still possible to create a geolocator data package with only the core ressources. 
:::

```{r 15-setup}
#| message: false
library(frictionless)
library(GeoLocatoR)
library(tidyverse)
library(zen4R)
```

::: callout-important

The easiest way to create a Zendo record and ensure that the data is correctly sync is using the Zenodo API and the [`Zen4R`](https://github.com/eblondel/zen4R/wiki) package.

For this, you first need to [create a token](https://zenodo.org/account/settings/applications/tokens/new/) and save it to your keyring with:

```{r 15-set-zenodo-token}
#| eval: false
keyring::key_set_with_value("ZENODO_PAT", password = "{your_zenodo_token}")
```

This allows us to create a `ZenodoManager` object which becomes useful later.

```{r 15-init-zenodo-manager}
zenodo <- ZenodoManager$new(token = keyring::key_get(service = "ZENODO_PAT"))
```

:::

## Setup of the example

For this example, we won't be using the Swainson's Warbler nor Great Reed Warbler as we want a full project with multiple tags. Instead, we download [the GeoPressureTemplate of the Woodland Kingfisher geolocator project](https://github.com/Rafnuss/WoodlandKingfisher). Our goal will essentially be to reproduce the [associated GeoLocator Data Package uploaded on Zenodo already](https://zenodo.org/records/13829929).

We can download this GeoPressureTemplate from Github in a temporary folder using the following code:

```{r 15-download-geopressuretemplate-example}
#| code-fold: true
#| message: false
repo <- "Rafnuss/WoodlandKingfisher"

# Create temporary file for the ZIP
temp_zip <- tempfile(fileext = ".zip")

# Download the ZIP file and unzip the repository
download.file(
  glue::glue("https://github.com/{repo}/archive/refs/heads/main.zip"),
  temp_zip,
  mode = "wb"
)
temp_dir <- tempfile()
unzip(temp_zip, exdir = temp_dir)

# return the extraction directory
directory <- file.path(temp_dir, list.files(temp_dir))
```

## Initiate datapackage with metadata

### Initiate datapackage using the DESCRIPTION file

We can generate a GeoLocator Data Package `pkg` from an existing GeoPressureTemplate folder with `create_gldp_geopressuretemplate()`. This function will read the `DESCRIPTION` file and create a frictionless package with the metadata you've already entered.

```{r 15-create-gldp-from-template}
pkg <- create_gldp_geopressuretemplate(directory = directory)
```

### Create record on Zenodo

The easiest way to update the metadata is to create an empty Zenodo record and fill in all metadata directly on Zenodo. This way, you can benefit from the Zenodo interface to enter all metadata and share it with co-authors for review before creating the package. 

```{r 15-create-zenodo-record}
#| eval: false
z <- zenodo$depositRecord(
  gldp_to_zenodo(pkg),
  reserveDOI = TRUE,
  publish = FALSE
)
browseURL(z$links$self_html)
```

### Update metadata on Zenodo

Login to Zenodo and fill in all metadata you want to add to your GeoLocator Data Package. Read the [datapackage specification](https://raphaelnussbaumer.com/GeoLocator-DP/datapackage/) to learn about all recommended metadata that can be added

::: callout-note
Note that a datapackage `contributors` corresponds to `creators` on Zenodo and not the `contributors`.
:::


::: callout-tip
To be able to save the draft of your record, you'll need to upload some file, even a dummy text file will do. You can always delete it later and upload with the correct ones.

Sharing the draft with co-authors is a great way to ensure that all metadata are correct before publication.
:::

### Create datapackage from Zenodo record

Once you're happy with the metadata entered on Zenodo, you create a new GeoLocator Data Package from the Zenodo record. For this, you need to retrieve the [concept DOI](https://support.zenodo.org/help/en-gb/1-upload-deposit/97-what-is-doi-versioning) of your Zenodo record. The concept DOI is the one that doesn't change with new versions. The DOI displayed on Zenodo is actually the DOI of the first version, but you can retrieve the concept DOI by substracting `1` to your ID number.

```{r 15-get-zenodo-concept-record}
#| eval: false
z <- zenodo$getDepositionByConceptDOI("10.5281/zenodo.{ZENODO_ID - 1}")
pkg <- zenodo_to_gldp(z)
```


## Add the data

Now that we have the metadata set up, we can add the data to the package. `add_gldp_geopressuretemplate()` is a key function that read the geopressuretemplate data available and automatically add the most up-to-date available data to the datapackage.

```{r 15-add-data-from-geopressuretemplate}
pkg <- add_gldp_geopressuretemplate(pkg, directory = directory)
```

## Data to include

By default, `add_gldp_geopressuretemplate()` adds first the tag data from the `data/interim` Rdata file. For all tag_id that don't have a interim file, it read the data directly from the `data/raw-data` folder, using `config.yml` information. Using the `from` argument, you can specify to only read from one of these two locations. It's possible to exclude specific tag_id by adding a `_` to the interim file name or raw-data folder (e.g., `_TAG1234.RData` or `_TAG1234/`). 

### `tags` and `observations` resources

If `tags.csv` and `observations.csv` are not available (i.e., not stored in the `data/` folder of your project), `tags` and `observations` resources would have been generated by `add_gldp_geopressuretemplate()` based on the available information. You certainly need to edit them manually, adding some key missing information (e.g. `ring_number`).

```{r 15-export-tags-observations}
#| eval: false
write.csv(tags(pkg), file = "data/tags.csv", row.names = FALSE)
write.csv(observations(pkg), file = "data/observations.csv", row.names = FALSE)
```

### Inspect the created package

Before uploading the data, you should also inspect the created package to ensure that everything is correct.

Check the summary of the package, in particular the number of tags in each resources.

```{r 15-inspect-pkg-summary}
print(pkg)
```

You can visualize the coverage of the package by ploting the Data Package. Check for the correct number of tags, as well as equipment and retrieval dates.

```{r 15-plot-pkg-coverage}
plot(pkg, "ring")
plot(pkg, "coverage")
plot(pkg, "map")
```

::: callout-important

Finally, we check that the package is compliant with GeoLocator Data Package standards.

```{r 15-validate-gldp}
#| collapse: true
validate_gldp(pkg)
```

It is quite normal that you'll first see some error here. Try to fix them and re-create the package until the package is valid. If you can't fix them, contact me!

:::


## Upload data to Zenodo


### Option 1: Manually

We can write the datapackage to file

```{r 15-write-package-basic}
#| eval: false
write_package(pkg)
```

The content of the folder created can now be uploaded on your Zenodo deposit.


### Option 2: Programatically

Alternatively, we can also upload the data to the deposit with

```{r 15-write-package-and-upload}
#| eval: false
write_package(pkg, directory = pkg$version)
for (f in list.files(pkg$version)) {
  zenodo$uploadFile(file.path(pkg$version, f), z)
}
```


## Publish the record

Finally, once you're happy with everything, you can publish the record on Zenodo
