# (PART) Labeling tools {-} 

# Pressurepath

In this chapter, we will mainly see what a `pressurepath` object is and how to use it, for instance, to compute the altitude of the bird throughout its trajectory. 

We are going to use the result from the Great Reed warbler 18LX from the advance tutorial.

```{r}
tag <- readRDS(file = "data/interim/tag-18LX.rds")
path_most_likely <- read.csv("data/processed/18LX/path_most_likely.csv") 
```


## Timeseries at a single position

Before creating a full `pressurepath`, I would like to start with the basic building block of a pressurepath which is to retrieve the pressure timeserie from ERA-5 at a single location. Similarly to `geopressure_map_mismatch`, it relies on [pressure timeseries entry point of GeoPressureAPI](https://raphaelnussbaumer.com/GeoPressureAPI/#pressure-timeseries). This function will create an Google Earth Engine request to be run on the GEE server which will return the timeseries as a csv file, and finally we read this csv file as a data.frame.

Let's start by a simple example using the first stationary period

```{r, cache=TRUE, message=FALSE}
ts <- geopressure_timeseries(lat = tag$stap$known_lat[1], lon = tag$stap$known_lon[1], start_time = tag$stap$start[1], end_time = tag$stap$end[1])
```

```{r}
p <- ggplot() +
  geom_line(data = ts, aes(x = date, y = pressure_era5, colour = "ERA5")) +
  geom_line(data = tag$pressure[tag$pressure$stap_id==1,], aes(x = date, y = value, colour = "tag")) +
  theme_bw() + ylab("Pressure (hPa)") +
  scale_color_manual(values = c("ERA5" = "black", "tag" = "red"))
layout(ggplotly(p), legend = list(orientation = "h"))
```

Moment d'Ã©motion: this figure was the one that made me realise the potential of pressure to determine the position! The accuracy of the reanalysis data and the precision of the tag was such that position estimation from pressure should offer a good complementarity with light data! 


## Pressurepath

Pressurepath can appear as a strange concept at first, but you'll see that it's a very convinient concept to visualize and label your track data. The basic idea behind is to compute the pressure timeseries that the tag would record along a specific path. To do that, `pressurepath_create()` basically call `geopressure_timeseries()` in parallel for all stationary periods and combine the resulting timeseries. 

```{r, cache=TRUE, message=FALSE, warning = F}
pressurepath <- pressurepath_create(tag, path = path_most_likely, include_flight = TRUE)
```

```{r}
plot_pressurepath(pressurepath)
```



## Altitude

Another nice output of the GeoPressureAPI is to compute the altitude of the bird throughout its trajectory. 

```{r}
plot_pressurepath(pressurepath, type = "altitude")
```

We can additionally request to compute the altitude during the next flight flight with `include_flight = c(0,1)`. Note that if a position of the path is over water, it will be moved to the closest point onshore.

The offset visible between the two timeseries corresponds to the altitude difference between ERA5 groundlevel altitude and the bird location. `geopressure_timeseries` can compute this altitude directly if you supply the `pressure` argument. We also benefit to known the temperature at ERA-5 groundlevel to adjust the barometric equation. 

The second operation you can perform with GeoPressureR is to compute the exact altitude of the bird $z_{gl}$ from its pressure measurement $P_{gl}$ using the barometric equation, correcting for the natural variation of pressure and temperature, 
$$ z_{gl}(x)=z_{ERA5}(x) + \frac{T_{ERA5}(x)}{L_b}  \left( \frac{P_{gl}}{P_{ERA5}(x)} \right) ^{\frac{RL_b}{g M}-1},$$
where $z_{ERA}$, $T_{ERA}$ and $P_{ERA}$  respectively correspond to the ground level elevation, temperature at 2m and ground level pressure of ERA5, $L_b$  is the standard temperature lapse rate, $R$ is the universal gas constant, $g$ is the gravity constant and  $M$ is the molar mass of air. See more information [on the GeoPressureAPI documentation](https://raphaelnussbaumer.com/GeoPressureAPI/#description-1).

```{r, cache=TRUE, message=FALSE}
ts <- geopressure_timeseries(lat = tag$stap$known_lat[1], lon = tag$stap$known_lon[1], pressure = tag$pressure[tag$pressure$stap_id==1,])
```
We can compare the altitude produced to the one computed without the correction for temperature and pressure:

```{r}
Lb <- -0.0065
R <- 8.31432
g0 <- 9.80665
M <- 0.0289644
T0 <- 273.15 + 15
P0 <- 1013.25
ts$altitude_uncorrected <- T0 / Lb * ((ts$pressure_tag / P0)^(-R * Lb / g0 / M) - 1)
```

and visualize this comparison:

```{r}
p <- ggplot(ts) +
  geom_line(aes(x = date, y = altitude, colour = "Corrected elevation with ERA5")) +
  geom_line(aes(x = date, y = altitude_uncorrected, colour = "Uncorrected elevation")) +
  theme_bw() + ylab("Pressure (hPa)") +
  scale_color_manual(values = c("Corrected elevation with ERA5" = "black", "Uncorrected elevation" = "red"))

plotly::layout(ggplotly(p), legend = list(orientation = "h"))
```



## Save

```{r, warning=F}
saveRDS(pressurepath, file = "data/interim/pressurepath-18LX.rds")
```
