# (PART) Labelling tools {-} 

# Pressurepath

In this chapter, we will see what a `pressurepath` object is and how to use it to compute the altitude of the bird throughout its trajectory. 

We will use results from the Great Reed Warbler (18LX), used in the [Advanced tutorial].

```{r}
tag <- readRDS(file = "data/interim/tag-18LX.rds")
path_most_likely <- read.csv("data/processed/18LX/path_most_likely.csv") 
```


## Timeseries at a single position

Before creating a full `pressurepath`, let's start with the basic building block of a pressurepath, which is to retrieve the pressure timeseries from ERA-5 at a single location. Similarly to `geopressure_map_mismatch`, it relies on the [pressure timeseries entry point of GeoPressureAPI](https://raphaelnussbaumer.com/GeoPressureAPI/#pressure-timeseries). This function creates a Google Earth Engine request to be run on the GEE server, which will return the timeseries as a .csv file. We then read this csv file as a data.frame.

Let's start by a simple example using the first stationary period:

```{r, cache=TRUE, message=FALSE}
ts <- geopressure_timeseries(lat = tag$stap$known_lat[1], lon = tag$stap$known_lon[1], start_time = tag$stap$start[1], end_time = tag$stap$end[1])
```

```{r}
p <- ggplot() +
  geom_line(data = ts, aes(x = date, y = pressure_era5, colour = "ERA5")) +
  geom_line(data = tag$pressure[tag$pressure$stap_id==1,], aes(x = date, y = value, colour = "tag")) +
  theme_bw() + ylab("Pressure (hPa)") +
  scale_color_manual(values = c("ERA5" = "black", "tag" = "red"))
layout(ggplotly(p), legend = list(orientation = "h"))
```

*Side note: this figure was the one that made me realize the potential of pressure to determine the bird's position! The accuracy of the reanalysis data and the precision of the tag were such that position estimates from pressure could effectively complement light data!*


## Pressurepath

Pressurepath is a convenient concept to visualize and label your track data. The basic idea behind it is to compute the pressure timeseries that the tag would record along a specific path. To do that, `pressurepath_create()` basically calls `geopressure_timeseries()` in parallel for all stationary periods and combines the resulting timeseries. 

```{r, cache=TRUE, message=FALSE, warning = F}
pressurepath <- pressurepath_create(tag, path = path_most_likely, include_flight = TRUE)
```

Note that if a position on the path is over water, it is automatically moved to the closest point onshore.


```{r}
plot_pressurepath(pressurepath)
```

## Altitude

The GeoPressureAPI is able to compute the altitude of the bird throughout its trajectory, which can be useful for further analysis. 

```{r}
plot_pressurepath(pressurepath, type = "altitude")
```

The `include_flight` function is particularly useful here as it helps compute altitude during the flight.

To extract the altitude, I suggest using the output of `pressurepath2altitude()` which conveniently provides a single altitude estimate per timestep. Indeed, altitude is computed based on a single position reference (i.e., the positions of the path), while the bird is moving during its flight. 

`include_flight` controls which reference stationary periods `stap_ref` are used (in general, both the previous and next stap_id are used).  `pressurepath2altitude()` combines the altitude estimates from the two stap_id to return the most accurate flight altitude.


<div class="alert alert-info" role="alert">
<h4 class="alert-heading mt-2"><strong>Why use GeoPressureAPI for altitude?</strong></h4>

Computing the bird altitude $z_{gl}$ from its pressure measurement $P_{gl}$ is always done using the barometric equation. Using GeoPressureAPI, we include in this equation the actual ground-level pressure $P_{ERA}$ and ground temperature $T_{ERA}$, thus correcting for the natural variation of pressure and temperature, 
$$ z_{gl}(x)=z_{ERA5}(x) + \frac{T_{ERA5}(x)}{L_b}  \left( \frac{P_{gl}}{P_{ERA5}(x)} \right) ^{\frac{RL_b}{g M}-1},$$
where $z_{ERA}$, $T_{ERA}$ and $P_{ERA}$  respectively correspond to the ground level elevation, temperature at 2m and ground level pressure of ERA5, $L_b$  is the standard temperature lapse rate, $R$ is the universal gas constant, $g$ is the gravity constant and  $M$ is the molar mass of air. See more information [on the GeoPressureAPI documentation](https://raphaelnussbaumer.com/GeoPressureAPI/#description-1).

We can compare the altitude produced to the one computed without the correction for temperature and pressure:

```{r, collapse = TRUE}
# include=FALSE
Lb <- -0.0065
R <- 8.31432
g0 <- 9.80665
M <- 0.0289644
T0 <- 273.15 + 15
P0 <- 1013.25
pressurepath$altitude_uncorrected <- T0 / Lb * ((pressurepath$pressure_tag / P0)^(-R * Lb / g0 / M) - 1)

p <- ggplot(pressurepath[pressurepath$stap_id == 1,]) +
  geom_line(aes(x = date, y = altitude, colour = "Corrected elevation with ERA5")) +
  geom_line(aes(x = date, y = altitude_uncorrected, colour = "Uncorrected elevation")) +
  theme_bw() + ylab("Pressure (hPa)") +
  scale_color_manual(values = c("Corrected elevation with ERA5" = "black", "Uncorrected elevation" = "red"))
plotly::layout(plotly::ggplotly(p), legend = list(orientation = "h"))
```

</div>



## Save

```{r, warning=F}
saveRDS(pressurepath, file = "data/interim/pressurepath-18LX.rds")
```
