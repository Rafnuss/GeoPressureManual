<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 3 Static map | A User Manual for GeoPressureR</title>
<meta name="author" content="Raphaël Nussbaumer">
<meta name="description" content="This chapter covers important pre-processing steps to ensure that modelling the trajectory with a graph is possible and successful. Firstly, we will aligned the maps of pressure and light and...">
<meta name="generator" content="bookdown 0.31 with bs4_book()">
<meta property="og:title" content="Chapter 3 Static map | A User Manual for GeoPressureR">
<meta property="og:type" content="book">
<meta property="og:url" content="https://raphaelnussbaumer.com/GeoPressureManual/static-map.html">
<meta property="og:image" content="https://raphaelnussbaumer.com/GeoPressureManual/assets/cover.png">
<meta property="og:description" content="This chapter covers important pre-processing steps to ensure that modelling the trajectory with a graph is possible and successful. Firstly, we will aligned the maps of pressure and light and...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 3 Static map | A User Manual for GeoPressureR">
<meta name="twitter:description" content="This chapter covers important pre-processing steps to ensure that modelling the trajectory with a graph is possible and successful. Firstly, we will aligned the maps of pressure and light and...">
<meta name="twitter:image" content="https://raphaelnussbaumer.com/GeoPressureManual/assets/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.0/htmlwidgets.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.1/leaflet-providers-plugin.js"></script><link href="libs/lfx-fullscreen-1.0.2/lfx-fullscreen-prod.css" rel="stylesheet">
<script src="libs/lfx-fullscreen-1.0.2/lfx-fullscreen-prod.js"></script><link href="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.css" rel="stylesheet">
<script src="libs/leaflet-awesomemarkers-2.0.3/leaflet.awesome-markers.min.js"></script><link href="libs/fontawesome-4.7.0/font-awesome.min.css" rel="stylesheet">
<link rel="icon" type="image/x-icon" href="https://raw.githubusercontent.com/Rafnuss/GeoPressureManual/main/assets/geopressuremanual.ico">
<!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-NJ17NCTPB5"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NJ17NCTPB5');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">A User Manual for GeoPressureR</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li><a class="" href="pressure-map.html"><span class="header-section-number">1</span> Pressure map</a></li>
<li><a class="" href="light-map.html"><span class="header-section-number">2</span> Light map</a></li>
<li><a class="active" href="static-map.html"><span class="header-section-number">3</span> Static map</a></li>
<li><a class="" href="basic-graph.html"><span class="header-section-number">4</span> Basic graph</a></li>
<li><a class="" href="wind-graph.html"><span class="header-section-number">5</span> Wind graph</a></li>
<li><a class="" href="export-and-visual.html"><span class="header-section-number">6</span> Export and Visual</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="labelling-tracks.html"><span class="header-section-number">A</span> Labelling tracks</a></li>
<li><a class="" href="geopressureviz.html"><span class="header-section-number">B</span> GeoPressureViz</a></li>
<li><a class="" href="probability-aggregation.html"><span class="header-section-number">C</span> Probability aggregation</a></li>
<li><a class="" href="gridded-gibbs-sampler.html"><span class="header-section-number">D</span> Gridded Gibbs sampler</a></li>
<li><a class="" href="resources.html"><span class="header-section-number">E</span> Resources</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/Rafnuss/GeoPressureManual/">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="static-map" class="section level1" number="3">
<h1>
<span class="header-section-number">3</span> Static map<a class="anchor" aria-label="anchor" href="#static-map"><i class="fas fa-link"></i></a>
</h1>
<p>This chapter covers important pre-processing steps to ensure that modelling the trajectory with a graph is possible and successful. Firstly, we will aligned the maps of pressure and light and create a <code>static_prob</code> variable containing all the information necessary for modeling the trajectory (incl. flight info).</p>
<p>But before moving too quickly, we need to carefully check that pressure, light and flight duration data allow for a coherent trajectory. It is possible (even probable) that some manual editing of the pressure data labelling will be required, especially for short stopovers.</p>
<div id="combine-pressure-and-light" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> Combine pressure and light<a class="anchor" aria-label="anchor" href="#combine-pressure-and-light"><i class="fas fa-link"></i></a>
</h2>
<p>Start by loading the data computed in <a href="light-map.html#light-map">Light map</a> and <a href="pressure-map.html#pressure-map">Pressure map</a>.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/1_pressure/18LX_pressure_prob.Rdata"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/2_light/18LX_light_prob.Rdata"</span><span class="op">)</span></span></code></pre></div>
<p>We first need to retrieve the pressure and light data for the same stationary period.</p>
<p>When running this code for the first time, it is recommended to start by keeping only long stationary periods (e.g. <code>thr_sta_dur=5\*24</code> hours), and when all the check below are passing, you can reduce this threshold to zero.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">thr_sta_dur</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># in hours</span></span>
<span><span class="va">sta_pres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">pressure_prob</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/metadata.html">metadata</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">sta_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sta_light</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">light_prob</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/metadata.html">metadata</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">sta_id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sta_thres</span> <span class="op">&lt;-</span> <span class="va">pam</span><span class="op">$</span><span class="va">sta</span><span class="op">$</span><span class="va">sta_id</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html">difftime</a></span><span class="op">(</span><span class="va">pam</span><span class="op">$</span><span class="va">sta</span><span class="op">$</span><span class="va">end</span>, <span class="va">pam</span><span class="op">$</span><span class="va">sta</span><span class="op">$</span><span class="va">start</span>, units <span class="op">=</span> <span class="st">"hours"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">thr_sta_dur</span><span class="op">]</span></span>
<span><span class="co"># Get the sta_id present on all three data sources</span></span>
<span><span class="va">sta_id_keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span><span class="op">(</span><span class="va">sta_pres</span>, <span class="va">sta_light</span><span class="op">)</span>, <span class="va">sta_thres</span><span class="op">)</span></span>
<span><span class="co"># Filter pressure and light map</span></span>
<span><span class="va">pressure_prob</span> <span class="op">&lt;-</span> <span class="va">pressure_prob</span><span class="op">[</span><span class="va">sta_pres</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">sta_id_keep</span><span class="op">]</span></span>
<span><span class="va">light_prob</span> <span class="op">&lt;-</span> <span class="va">light_prob</span><span class="op">[</span><span class="va">sta_light</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">sta_id_keep</span><span class="op">]</span></span></code></pre></div>
<p>We then need to keep all the flights between consecutive stationary period separate so that we can estimate the wind support correctly.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flight</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i_f</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sta_id_keep</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">from_sta_id</span> <span class="op">&lt;-</span> <span class="va">sta_id_keep</span><span class="op">[</span><span class="va">i_f</span><span class="op">]</span></span>
<span>  <span class="va">to_sta_id</span> <span class="op">&lt;-</span> <span class="va">sta_id_keep</span><span class="op">[</span><span class="va">i_f</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">flight</span><span class="op">[[</span><span class="va">i_f</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    start <span class="op">=</span> <span class="va">pam</span><span class="op">$</span><span class="va">sta</span><span class="op">$</span><span class="va">end</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">from_sta_id</span>, <span class="va">to_sta_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    end <span class="op">=</span> <span class="va">pam</span><span class="op">$</span><span class="va">sta</span><span class="op">$</span><span class="va">start</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">from_sta_id</span> <span class="op">+</span> <span class="fl">1</span>, <span class="va">to_sta_id</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    sta_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">from_sta_id</span>, <span class="va">to_sta_id</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">flight</span><span class="op">[[</span><span class="va">i_f</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We compute the static probability with the product of light and pressure probability maps, and add the flight duration in the metadata. <code>static_prob</code> is the consolidate variable containing all the information necessary to run the graph functions.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">static_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">light</span>, <span class="va">pressure</span>, <span class="va">flight</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># define static prob as the product of light and pressure prob</span></span>
<span>  <span class="va">static_prob</span> <span class="op">&lt;-</span> <span class="va">light</span> <span class="op">*</span> <span class="va">pressure</span></span>
<span></span>
<span>  <span class="co"># replace na by zero</span></span>
<span>  <span class="co"># tmp &lt;- values(static_prob)</span></span>
<span>  <span class="co"># tmp[is.na(tmp)] &lt;- 0</span></span>
<span>  <span class="co"># values(static_prob) &lt;- tmp</span></span>
<span></span>
<span>  <span class="fu">metadata</span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">metadata</span><span class="op">(</span><span class="va">pressure</span><span class="op">)</span></span>
<span>  <span class="fu">metadata</span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span><span class="op">$</span><span class="va">flight</span> <span class="op">&lt;-</span> <span class="va">flight</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span></span>
<span><span class="op">}</span>, <span class="va">light_prob</span>, <span class="va">pressure_prob</span>, <span class="va">flight</span><span class="op">)</span></span></code></pre></div>
<p>We overwrite the probability of the first and last stationary periods with the known location of the equipment/retrieval sites.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lon_calib</span> <span class="op">&lt;-</span> <span class="fl">17.05</span></span>
<span><span class="va">lat_calib</span> <span class="op">&lt;-</span> <span class="fl">48.9</span></span>
<span></span>
<span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/xmin.html">ymax</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/xmin.html">ymin</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="va">lat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">lat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/xmin.html">xmin</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/xmin.html">xmax</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="va">lon</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lon</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">lon</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></span>
<span></span>
<span><span class="va">lon_calib_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">lon_calib</span> <span class="op">-</span> <span class="va">lon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lat_calib_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">lat_calib</span> <span class="op">-</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="va">lat_calib_id</span>, <span class="va">lon_calib_id</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu">values</span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tmp</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">tmp</span><span class="op">[</span><span class="va">lat_calib_id</span>, <span class="va">lon_calib_id</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu">values</span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tmp</span></span></code></pre></div>
<p>Finally, we can retrieve the pressure and altitude from the most likely position of the combined map of pressure and light.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://raphaelnussbaumer.com/GeoPressureR/reference/geopressure_map2path.html">geopressure_map2path</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span></span>
<span><span class="va">static_timeserie</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://raphaelnussbaumer.com/GeoPressureR/reference/geopressure_ts_path.html">geopressure_ts_path</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">pam</span><span class="op">$</span><span class="va">pressure</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="check-track-with-geopressureviz" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Check track with GeoPressureViz<a class="anchor" aria-label="anchor" href="#check-track-with-geopressureviz"><i class="fas fa-link"></i></a>
</h2>
<p>Now that we have combined pressure and light, we need to verify that the data is coherent.</p>
<p>In <a href="labelling-tracks.html#labelling-tracks">Labelling tracks</a>, we already checked that the pressure timeseries measured by the geolocator are consistent with a least one location on the map. However, we didn’t check whether these locations are (1) coherent with light data, and (2) within reach of one another, considering flight duration and realistic flight speed.</p>
<p>To carry out these checks, you can use the shiny app <code>GeoPressureViz</code> which helps you visualize the overall trajectory of the bird as well as each step-by-step move.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="static-map.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">geopressureviz</span>(</span>
<span id="cb48-2"><a href="static-map.html#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pam =</span> pam,</span>
<span id="cb48-3"><a href="static-map.html#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pressure_prob =</span> pressure_prob,</span>
<span id="cb48-4"><a href="static-map.html#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">light_prob =</span> light_prob</span>
<span id="cb48-5"><a href="static-map.html#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">static_prob =</span> static_prob, </span>
<span id="cb48-6"><a href="static-map.html#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pressure_timeserie =</span> static_timeserie </span>
<span id="cb48-7"><a href="static-map.html#cb48-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Learn more about this app in the dedicated chapter <a href="geopressureviz.html#geopressureviz">GeoPressureViz</a>.</p>
<p>With GeoPressureViz, we want to check that the probability map is coherent with the flight distance from the previous/next location and ultimately that a overal trajectory is possible/present in the data. If you notice any inconsistency, go back to the labellisation step (for pressure and light) and check again.</p>
<p>I suggest starting by selecting only long stopovers (24-72 hours depending on your application), as this will help to draw out the general trajectory followed by the bird, and only later adding the shorter stopovers which could raise more confusion (the best match of pressure is often completely off).</p>
<p>Following the same recommendation than in <a href="labelling-tracks.html#labelling-tracks">Labelling tracks</a>, you want the non-outlier pressure of each stationary period to match a single elevation timeserie (bottom panel). You can check on the map that the pressure location seem coherent by selecting only “pressure” in the probability map display. Usually, it’s pretty obvious when there is an issue on the map.</p>
<p>So, to correct any issue, go back to trainset and edit (1) labelling of activity to split or combine stationary periods and (2) labelling the pressure timeserie to exclude certain datapoints from the match. The good match of the timeserie is essential and will require several iteration.</p>
<p>Some additional notes:</p>
<ul>
<li>The distance is computed based on an assumed average groundspeed. Birds can fly with a groundspeed up to 120-150 km/h (with wind support) although their usual average is around 40km/h.</li>
<li>The default position of the bird in GeoPressureViz is based on the most likely position from the static probability map. This is (usually) not the correct location.</li>
<li>Bird tend to flight directly to their main destination. Most detour are artifact, or you really need a long stationary period with a good match of pressure.</li>
<li>The most regular issue I faced is a small vertical movement of the bird during a 2-8 days stopover. Shorter stopover are usually easy as the bird doesn’t move much but each species is different.</li>
<li>Wind data is not yet included and might explain some longer flight (sometimes up to 100km/h).</li>
</ul>
</div>
<div id="final-checks" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> Final checks<a class="anchor" aria-label="anchor" href="#final-checks"><i class="fas fa-link"></i></a>
</h2>
<p>These checks are performed when creating the graph <code><a href="https://raphaelnussbaumer.com/GeoPressureR/reference/graph_create.html">graph_create()</a></code>, but for pedagogical reason, I thought it would be better to introduce them step by step here as they will also help you to get a better sense of the specific movement/trajectory of the bird you are modeling.</p>
<div id="check-1" class="section level3" number="3.3.1">
<h3>
<span class="header-section-number">3.3.1</span> Check 1<a class="anchor" aria-label="anchor" href="#check-1"><i class="fas fa-link"></i></a>
</h3>
<p>A first and easy check is that there be at least one location with a probability greater than 1 for each stationary period.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">static_prob_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">static_prob</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">probt</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">probt</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">probt</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">probt</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">probt</span>, na.rm <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">static_prob_n</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"The `static_prob` provided has a probability map equal to "</span>,</span>
<span>    <span class="st">"zero for the stationary period: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="check-2" class="section level3" number="3.3.2">
<h3>
<span class="header-section-number">3.3.2</span> Check 2<a class="anchor" aria-label="anchor" href="#check-2"><i class="fas fa-link"></i></a>
</h3>
<p>Secondly, we check that there always be at least one possible transition from one stationary period to the next.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i_s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cur</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="va">i_s</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="va">cur</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cur</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">F</span></span>
<span>  <span class="va">nex</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="va">i_s</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="va">nex</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">nex</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">F</span></span>
<span></span>
<span>  <span class="va">mtf</span> <span class="op">&lt;-</span> <span class="fu">metadata</span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="va">i_s</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">flight_duration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html">difftime</a></span><span class="op">(</span><span class="va">mtf</span><span class="op">$</span><span class="va">flight</span><span class="op">$</span><span class="va">end</span>, <span class="va">mtf</span><span class="op">$</span><span class="va">flight</span><span class="op">$</span><span class="va">start</span>, unit <span class="op">=</span> <span class="st">"hours"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># hours</span></span>
<span>  <span class="va">resolution</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu">res</span><span class="op">(</span><span class="va">static_prob</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">111</span> <span class="co"># assuming 1°= 111km</span></span>
<span>  <span class="va">thr_gs</span> <span class="op">&lt;-</span> <span class="fl">150</span> <span class="co"># Assuming a max groundspeed of 150km/h</span></span>
<span></span>
<span>  <span class="co"># Check possible position at next stationary period</span></span>
<span>  <span class="va">possible_next</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu">EBImage</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/EBImage/man/distmap.html">distmap</a></span><span class="op">(</span><span class="op">!</span><span class="va">cur</span><span class="op">)</span> <span class="op">*</span> <span class="va">resolution</span> <span class="op">/</span> <span class="va">flight_duration</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">thr_gs</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">possible_next</span> <span class="op">&amp;</span> <span class="va">nex</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"There are no possible transition from stationary period"</span>, <span class="va">i_s</span>, <span class="st">"to"</span>, <span class="va">i_s</span> <span class="op">+</span> <span class="fl">1</span>, <span class="st">". Check part 1 process (light and pressure)"</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div id="save-2" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Save<a class="anchor" aria-label="anchor" href="#save-2"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span></span>
<span>  <span class="va">static_prob</span>,</span>
<span>  <span class="va">static_timeserie</span>,</span>
<span>  file <span class="op">=</span> <span class="st">"data/3_static/18LX_static_prob.Rdata"</span></span>
<span><span class="op">)</span></span></code></pre></div>

</div>
</div>
<script>
document.getElementsByClassName("book-toc")[0].insertAdjacentHTML("afterend",
                "<div class='text-center'><a href='https://github.com/Rafnuss/GeoPressureTemplate' target='_blank' class='btn btn-sm btn-outline-primary' role='button'>Start your own study</a></div>");
</script><div class="chapter-nav">
<div class="prev"><a href="light-map.html"><span class="header-section-number">2</span> Light map</a></div>
<div class="next"><a href="basic-graph.html"><span class="header-section-number">4</span> Basic graph</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#static-map"><span class="header-section-number">3</span> Static map</a></li>
<li><a class="nav-link" href="#combine-pressure-and-light"><span class="header-section-number">3.1</span> Combine pressure and light</a></li>
<li><a class="nav-link" href="#check-track-with-geopressureviz"><span class="header-section-number">3.2</span> Check track with GeoPressureViz</a></li>
<li>
<a class="nav-link" href="#final-checks"><span class="header-section-number">3.3</span> Final checks</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#check-1"><span class="header-section-number">3.3.1</span> Check 1</a></li>
<li><a class="nav-link" href="#check-2"><span class="header-section-number">3.3.2</span> Check 2</a></li>
</ul>
</li>
<li><a class="nav-link" href="#save-2"><span class="header-section-number">3.4</span> Save</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/Rafnuss/GeoPressureManual//blob/main/03-static_map.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/Rafnuss/GeoPressureManual//edit/main/03-static_map.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>A User Manual for GeoPressureR</strong>" was written by Raphaël Nussbaumer. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
