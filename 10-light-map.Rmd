
# (PART) Advanced Tutorial {-} 

# Light map

In this chapter, we will see how to construct a likelihood map of the Great Reed Warbler (18LCX) from light data. This step is optional in the workflow, and typically does not drastically change the result, but can be helpful to increase the computational efficiency during the creation of the graph. 

Here, we use an approach based on the simple threshold based method, using a calibration of zenith angle. A more thorough introduction to geolocation with light data can be found in <https://geolocationmanual.vogelwarte.ch/> [@Lisovski2020]. Note that other methods producing likelihood maps could also be used (e.g., @Basson2016 and @Bindoff2018).

## Basic tutorial catch up

In the [Basic tutorial], we went through the overall workflow using a simple example. In this tutorial, we include light data and use wind data in the estimation of the trajectory with the example of a [Great Reed Warbler](https://ebird.org/species/grrwar1)(`18LX`).

First, we use a fast-forward code to perform the steps already covered in the basic tutorial, using the native pipe operator `|>`. Note that this assumes the labelling has already been done. 

```{r, message=FALSE, results='hide'}
tag <- tag_create("18LX", 
                  crop_start = "2017-06-20", 
                  crop_end = "2018-05-02") |>
  tag_label() |>
  tag_geostap(
    extent = c(-16, 23, 0, 50),
    scale = 5,
    known = data.frame(
      stap_id = 1, 
      known_lat = 48.9,
      known_lon = 17.05
      )
  ) |>
  geopressure_map()
```

## Estimate twilights

To find the twilight (time of sunrise and sunset every day), we use `twilight_create()`. This function performs the same tasks as [`TwGeos::FindTwilight()`](https://rdrr.io/github/slisovski/TwGeos/man/findTwilights.html), but uses a matrix representation. This approach is faster but less general (e.g., requires regularly spaced light data).

By default, the threshold of light (`twl_thr = NULL`) defining a twilight is computed as the first and last light of the day (i.e., `tag$light$vale>0`). The `twl_offset` parameter (identical to the `offset` argument in the `GeoLight` functions) is used to center the night/day on the matrix representation of light. A good centering is necessary to compute the correct twilight.

```{r}
tag <- twilight_create(tag, 
                       twl_thr = NULL,
                       twl_offset = NULL)
```

We can visualize the twilight and check the centering of the day. 

```{r}
plot(tag, type = "twilight")
```

Re-run `twilight_create` with a different `twl_offset` until the night/day is properly centered. The color of the dots indicates which stationary period the twilight belongs to, as defined with the tag label. This can be useful to distinguish outliers from a change in the bird position.  

## Manual labelling of twilight

Twilight outliers should be discarded from the analysis using [Trainset](https://trainset.raphaelnussbaumer.com/). 

Use `twilight_label_write` to generate the twilight label `csv` file which can then be opened and edited in [Trainset](https://trainset.raphaelnussbaumer.com/).

```{r, message=FALSE, results='hide'}
twilight_label_write(tag)
```

Click on "Upload Twilight Label" to customize the interface for twilight labelling. Similar to tag labelling, simply label the twilights to be ignored with the `"discard"` label.

<div class="alert alert-info" role="alert">
<h4 class="alert-heading mt-2"><strong>How to pick out outliers</strong></h4>
If you have already labelled your tag, the stationary periods have been computed and the twilights are illustrated with a different color on Trainset This is useful to pick out outliers from a change in the bird's position: while changes in twilight within a stationary period should be smooth, changes between positions are abrupt. 
*Note that modifying the label of twilight to a different stationary period has no influence later on, as only discarded labels are read with `twilight_label_read`.*

**Do not over-edit the calibration period!**. It is easier to pick out errors during long stationary periods. However, during short ones, it might not be possible to distinguish an outlier from part of a new position. The calibration will use the range of values possible ... etc.
</div>



When you have finished labelling, export the file in the same folder keeping `-labeled` in the name (automatically added by Trainset). `twilight_label_read` will automatically know which file to read.

```{r}
tag <- twilight_label_read(tag)
plot(tag, type = "twilight")
```

## Compute likelihood map

The computation of the light likelihood map for each stationary period is performed with `geolight_map()`. It follows these three steps:

1. Perform a calibration which requires knowing the position of the bird for a least one stationary period. This position should be specified with the `known` data.frame when running `tag_geostap()`. We use a kernel density fitted on the zenith angle error (see section 2.4 in @Nussbaumer2023a for more detail). 
2. Compute a likelihood map for each twilight using the calibration.
3. Combine all likelihood maps of the same stationary period using a log-linear pooling with a weighting function `twl_llp`. See [probability-aggregation.html] for more information on probability aggregation.


```{r, message=FALSE, results='hide'}
tag <- geolight_map(tag,
                    twl_calib_adjust = 1.4, 
                    twl_llp = function(n) 0.1)
```
The `twl_calib_adjust` parameter adjusts the smoothness of the fit (see `stats::density()`). Because the zenith angle error model is fitted with data only at the calibration site, and we are using it for all locations of the bird's journey, it is safer to assume a broader/smoother distribution (`twl_calib_adjust >`). 

It is recommended to always check the calibration fit (`tag$param$twl_calib`):

```{r}
barW <- median(diff(tag$param$twl_calib$x))/2
plot(tag$param$twl_calib)
rect(xleft=tag$param$twl_calib$x-barW, ybottom=0, xright=tag$param$twl_calib$x+barW, ytop=tag$param$twl_calib$y, col = gray(0.5))
lines(tag$param$twl_calib, col = "red")
```

Finally, we can visualize the probability map for each stationary period:

```{r, warning=F}
plot(tag, type = "map_light")
```

## Save

```{r, warning=F}
saveRDS(tag, file = "./data/interim/tag-18LX.rds")
```
